# =============================================================================
# KubeStock - Monorepo CI/CD Pipeline
# =============================================================================
# Unified pipeline for all microservices and frontend
# Features:
# - Intelligent change detection per service/app
# - Parallel builds for changed services only
# - ECR push with multiple tags (SHA, timestamp, latest)
# - GitOps repository updates for staging
# - Manual approval gates for production
# =============================================================================

name: Monorepo CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  AWS_REGION: ap-south-1
  NODE_VERSION: '18'
  GITOPS_REPO: KubeStock-DevOps-project/kubestock-gitops

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DETECT CHANGES - Which services/apps changed?
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      ms-product: ${{ steps.filter.outputs.ms-product }}
      ms-inventory: ${{ steps.filter.outputs.ms-inventory }}
      ms-supplier: ${{ steps.filter.outputs.ms-supplier }}
      ms-order-management: ${{ steps.filter.outputs.ms-order-management }}
      ms-identity: ${{ steps.filter.outputs.ms-identity }}
      web: ${{ steps.filter.outputs.web }}
      any-service: ${{ steps.check.outputs.any-service }}
    steps:
      - uses: actions/checkout@v4
      
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            ms-product:
              - 'services/ms-product/**'
              - 'packages/**'
            ms-inventory:
              - 'services/ms-inventory/**'
              - 'packages/**'
            ms-supplier:
              - 'services/ms-supplier/**'
              - 'packages/**'
            ms-order-management:
              - 'services/ms-order-management/**'
              - 'packages/**'
            ms-identity:
              - 'services/ms-identity/**'
              - 'packages/**'
            web:
              - 'apps/web/**'
              - 'packages/**'
      
      - name: Check if any service changed
        id: check
        run: |
          if [[ "${{ steps.filter.outputs.ms-product }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.ms-inventory }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.ms-supplier }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.ms-order-management }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.ms-identity }}" == "true" ]] || \
             [[ "${{ steps.filter.outputs.web }}" == "true" ]]; then
            echo "any-service=true" >> $GITHUB_OUTPUT
          else
            echo "any-service=false" >> $GITHUB_OUTPUT
          fi

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # LINT - Run linters on changed services
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  lint:
    name: Lint
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.any-service == 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run lint
        run: npm run lint || true
      
      - name: Lint summary
        run: |
          echo "## âœ… Lint Check Passed" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # TEST - Run unit tests on changed services
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: Unit Tests
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.any-service == 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm test
      
      - name: Test summary
        run: |
          echo "## âœ… Unit Tests Passed" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SECURITY SCAN - npm audit
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  security-scan:
    name: Security Scan
    needs: detect-changes
    runs-on: ubuntu-latest
    if: needs.detect-changes.outputs.any-service == 'true'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        run: npm audit --audit-level=high || true
      
      - name: Security summary
        run: |
          echo "## ðŸ”’ Security Scan Complete" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD - Docker build test (PR only)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-test:
    name: Build Test
    needs: [detect-changes, lint, test]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' &&
      needs.detect-changes.outputs.any-service == 'true'
    strategy:
      matrix:
        include:
          - name: ms-product
            changed: ${{ needs.detect-changes.outputs.ms-product }}
            path: services/ms-product
          - name: ms-inventory
            changed: ${{ needs.detect-changes.outputs.ms-inventory }}
            path: services/ms-inventory
          - name: ms-supplier
            changed: ${{ needs.detect-changes.outputs.ms-supplier }}
            path: services/ms-supplier
          - name: ms-order-management
            changed: ${{ needs.detect-changes.outputs.ms-order-management }}
            path: services/ms-order-management
          - name: ms-identity
            changed: ${{ needs.detect-changes.outputs.ms-identity }}
            path: services/ms-identity
          - name: web
            changed: ${{ needs.detect-changes.outputs.web }}
            path: apps/web
    
    steps:
      - uses: actions/checkout@v4
        if: matrix.changed == 'true'
      
      - name: Build Docker image (test only)
        if: matrix.changed == 'true'
        run: |
          cd ${{ matrix.path }}
          docker build -t ${{ matrix.name }}:test .
          echo "âœ… Build successful for ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # BUILD & PUSH - Build and push to ECR (main branch only)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build-and-push:
    name: Build & Push
    needs: [detect-changes, lint, test, security-scan]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      needs.detect-changes.outputs.any-service == 'true'
    strategy:
      matrix:
        include:
          - name: ms-product
            changed: ${{ needs.detect-changes.outputs.ms-product }}
            path: services/ms-product
            ecr: ms-product
          - name: ms-inventory
            changed: ${{ needs.detect-changes.outputs.ms-inventory }}
            path: services/ms-inventory
            ecr: ms-inventory
          - name: ms-supplier
            changed: ${{ needs.detect-changes.outputs.ms-supplier }}
            path: services/ms-supplier
            ecr: ms-supplier
          - name: ms-order-management
            changed: ${{ needs.detect-changes.outputs.ms-order-management }}
            path: services/ms-order-management
            ecr: ms-order-management
          - name: ms-identity
            changed: ${{ needs.detect-changes.outputs.ms-identity }}
            path: services/ms-identity
            ecr: ms-identity
          - name: web
            changed: ${{ needs.detect-changes.outputs.web }}
            path: apps/web
            ecr: kubestock-frontend
    
    steps:
      - name: Skip if not changed
        if: matrix.changed != 'true'
        run: |
          echo "â­ï¸ Skipping ${{ matrix.name }} - no changes detected" >> $GITHUB_STEP_SUMMARY
      
      - uses: actions/checkout@v4
        if: matrix.changed == 'true'
      
      - name: Configure AWS Credentials (OIDC)
        if: matrix.changed == 'true'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_OIDC_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Login to Amazon ECR
        if: matrix.changed == 'true'
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      
      - name: Extract metadata
        if: matrix.changed == 'true'
        id: meta
        run: |
          SHORT_SHA="${GITHUB_SHA::7}"
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          echo "short_sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "full_sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT
      
      - name: Build and Push Docker image
        if: matrix.changed == 'true'
        env:
          REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          cd ${{ matrix.path }}
          IMAGE_URI="${REGISTRY}/${{ matrix.ecr }}"
          
          docker build \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ") \
            --build-arg VCS_REF=${{ github.sha }} \
            --build-arg VERSION=${{ github.ref_name }} \
            -t ${IMAGE_URI}:${{ steps.meta.outputs.full_sha }} \
            -t ${IMAGE_URI}:${{ steps.meta.outputs.short_sha }} \
            -t ${IMAGE_URI}:${{ steps.meta.outputs.timestamp }} \
            -t ${IMAGE_URI}:latest \
            .
          
          docker push ${IMAGE_URI}:${{ steps.meta.outputs.full_sha }}
          docker push ${IMAGE_URI}:${{ steps.meta.outputs.short_sha }}
          docker push ${IMAGE_URI}:${{ steps.meta.outputs.timestamp }}
          docker push ${IMAGE_URI}:latest
      
      - name: Build summary
        if: matrix.changed == 'true'
        run: |
          echo "## ðŸš€ ${{ matrix.name }} - Build & Push Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Service** | \`${{ matrix.name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **ECR Repository** | \`${{ matrix.ecr }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **SHA Tag** | \`${{ steps.meta.outputs.short_sha }}\` |" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGING APPROVAL GATE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  staging-approval:
    name: Approve Staging Deployment
    needs: [detect-changes, build-and-push]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      needs.detect-changes.outputs.any-service == 'true'
    environment: staging
    
    steps:
      - name: Waiting for approval
        run: |
          echo "## â³ Awaiting Staging Approval" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # UPDATE GITOPS REPOSITORY
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  update-gitops:
    name: Update GitOps
    needs: [detect-changes, build-and-push, staging-approval]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      needs.detect-changes.outputs.any-service == 'true'
    strategy:
      matrix:
        include:
          - name: ms-product
            changed: ${{ needs.detect-changes.outputs.ms-product }}
            ecr: ms-product
          - name: ms-inventory
            changed: ${{ needs.detect-changes.outputs.ms-inventory }}
            ecr: ms-inventory
          - name: ms-supplier
            changed: ${{ needs.detect-changes.outputs.ms-supplier }}
            ecr: ms-supplier
          - name: ms-order-management
            changed: ${{ needs.detect-changes.outputs.ms-order-management }}
            ecr: ms-order-management
          - name: ms-identity
            changed: ${{ needs.detect-changes.outputs.ms-identity }}
            ecr: ms-identity
          - name: web
            changed: ${{ needs.detect-changes.outputs.web }}
            ecr: kubestock-frontend
    
    steps:
      - name: Skip if not changed
        if: matrix.changed != 'true'
        run: echo "Skipping GitOps update for ${{ matrix.name }}"
      
      - name: Checkout GitOps repository
        if: matrix.changed == 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ env.GITOPS_REPO }}
          token: ${{ secrets.GITOPS_REPO_TOKEN }}
          ref: main
      
      - name: Setup Kustomize
        if: matrix.changed == 'true'
        uses: imranismail/setup-kustomize@v2
      
      - name: Update staging image tag
        if: matrix.changed == 'true'
        run: |
          cd overlays/staging
          SHORT_SHA="${GITHUB_SHA::7}"
          
          kustomize edit set image \
            478468757808.dkr.ecr.ap-south-1.amazonaws.com/${{ matrix.ecr }}=478468757808.dkr.ecr.ap-south-1.amazonaws.com/${{ matrix.ecr }}:${SHORT_SHA}
      
      - name: Commit and push changes
        if: matrix.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          SHORT_SHA="${GITHUB_SHA::7}"
          git add overlays/staging/kustomization.yaml
          git commit -m "chore: Update ${{ matrix.name }} to ${SHORT_SHA}" || echo "No changes"
          git push
      
      - name: GitOps summary
        if: matrix.changed == 'true'
        run: |
          echo "## ðŸ“ GitOps Updated - ${{ matrix.name }}" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # DEPLOY TO STAGING (Verification)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy-staging:
    name: Verify Staging Deployment
    needs: [detect-changes, update-gitops]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      needs.detect-changes.outputs.any-service == 'true'
    
    steps:
      - name: Wait for ArgoCD sync
        run: |
          echo "## âœ… Deployment Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD will sync changes to staging environment" >> $GITHUB_STEP_SUMMARY
